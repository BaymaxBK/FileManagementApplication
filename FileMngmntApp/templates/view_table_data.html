{% extends "base.html" %}
{% load custom_tags %}

{% block title %} {{ table.display_name }} - Data{% endblock %}


{% block content %}

<style>
    /* Freeze the Action column (last column) */
    #dataTable th:last-child,
    #dataTable td:last-child {
        position: sticky; 
        right: 0;
        top:10;              /* stick to the right */
        z-index: 5;            /* keep above other cells */
        background: white;     /* avoid overlap transparency */
        box-shadow: -2px 0 4px rgba(0,0,0,0.1); /* slight shadow for clarity */
    }

    #dataTable th:first-child,
    #dataTable td:first-child {
        position: sticky;
        left: 0;
        z-index: 6;
        background: white;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
    }
</style>

<div class="container mt-4">

    <div class="container mt-3">
        <div class="row mb-2">
            
            <div class="col">
                <h4>Display Columns</h4>
            </div>

            <div class="col text-end">
                <button id="toggleColumnSelector" class="btn btn-secondary btn-sm me-2">Show</button>
            </div>

            <div id="columnSelectorWrapper" style="display: none;">
                <div id="columnSelector" class="mb-3"></div>
                
                <div class="text-end">
                    <button id="colSelAplyBtn_Id" class="col btn btn-primary btn-sm">Apply Columns</button>
                </div>
            </div>
        </div>
    </div>
    <hr>

    <h4 class="bg-light">{{ table.display_name }} <small class="text-muted">({{ table.table_name }})</small></h4>

    {% if rows %}
    <form id="MainForm">

        <div class="d-flex justify-content-end align-items-center mb-3">
            <label for="rowLimit" class="form-label px-3">Rows per page:</label>
            <select name="limit" id="rowLimit" class="form-select w-auto mx-3" >
                <option value="5" {% if limit == 5 %}selected{% endif %}>5</option>
                <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if limit == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
                <option value="1000" {% if limit == 1000 %}selected{% endif %}>1000</option>
                <option value="2000" {% if limit == 2000 %}selected{% endif %}>2000</option>
                <option value="5000" {% if limit == 5000 %}selected{% endif %}>5000</option>
                <option value="10000" {% if limit == 10000 %}selected{% endif %}>10000</option>
                <option value="50000" {% if limit == 10000 %}selected{% endif %}>50000</option>
                <option value="100000" {% if limit == 10000 %}selected{% endif %}>100000</option>
                <option value="all" {% if limit == "all" %}selected{% endif %}>All Records</option>
            </select>
            <button id="addItemBtn" class="btn btn-success add-Item-btn">+ Add Item</button>
            <button class="btn btn-primary mx-2 AssignTask-btn">Assign Task</button>            
        </div>

        <!-- TASK FORM -->

        <div id="taskDivId" class="border py-2 rounded flex-center mb-2" style="display:none;">
            
                <label for="rowLimit" class="form-label px-3">TaskName</label>
                <input id="taskName" type="text" class="form-control w-50" >
                <select id="userSelect" class="form-select w-auto mx-3" >

                    <option value="" selected>- select user -</option>
                    {% for user in users%}
                        <option value="{{user.username}}" >{{user.username}}</option>
                    {% endfor %}
                    
                </select>
                <button id="AssingId" class="btn btn-success">Assign</button>
                <button id="ShowSelRowBtn" class="btn btn-secondary ms-2">Show</button>            
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover text-center" id="dataTable">
                <thead class="table-light">
                    <tr>
                        <td> </td>

                        {% for col in columns %}
                            <th>
                                
                                <!-- Filter -->
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                        {{ col }}
                                    </button>
                                    <div class="dropdown-menu p-2" style="max-height:400px; width:auto; overflow:auto;">
                                        
                                        <input type="text" class="form-control mb-2 filter-search" placeholder="Search {{ col }}">
                                        
                                        <!-- Select All -->
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input filter-select-all" data-col="{{ forloop.counter0 }}" checked>
                                            <label class="form-check-label">Select All</label>
                                        </div>
                                        
                
                                        <div class="filter-options-wrapper" style="max-height:180px; overflow:auto;">
                                            <div class="filter-options" data-col="{{ forloop.counter0 }}">
                                                <!-- checkboxes will be populated by JS -->
                                            </div>
                                        </div>

                                        <div class="filter-footer mt-2 d-flex justify-content-between border-top pt-2" style="position: sticky; bottom: 0; background: #fff;">
                                            <button class="btn btn-sm btn-primary filter-ok" data-col="{{ forloop.counter0 }}">OK</button>
                                            <button class="btn btn-sm btn-secondary filter-clear" data-col="{{ forloop.counter0 }}">Clear</button>
                                        </div>

                                    </div>
                                </div>
                            </th>
                        {% endfor %}
                        <th class="flex-center gap-2">Action 
                            <div class="selectAllDiv" style="display: none;" >
                                <input type="checkbox" class="d-none">
                                <button type="button" id="SelectAllId" class="SelectAllcls btn btn-outline-primary btn-sm w-100 text-nowrap"> Select All</button>
                            </div>
                        </th>

                    </tr>

                </thead>
                <tbody>
                    {% for row in rows %}
                        <tr data-row-id="{{ row.id }}">
                            <td style="color: blue;border:none;">{{ forloop.counter }}</td>
                            {% for col in columns %}
                                <td class="text-nowrap" contenteditable={% if col != "id" %} "true" {% else %} "false" {% endif %} data-field="{{ col }}" tabindex="-1">{{ row|get_item:col|format_date_auto }}</td>
                            {% endfor %}

                            <td class="flex-center gap-1">
                                <button type="button" class="btn btn-danger btn-sm delete-row-btn">Delete</button>
                                <button type="button" class="btn btn-info btn-sm view-row-btn"> View </button>
                                <div class="selectDiv" style="display: none;">
                                    <input type="checkbox" class="row-checkbox d-none" name="selected_rows" value="{{ row.id }}">
                                    <button type="button" class="btn btn-outline-primary btn-sm select-row-btn"> Select </button>
                                </div>
                            </td>

                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="navbar-wrapper" style="overflow:auto;">
                <nav id="paginationNav">
                    <ul class="pagination">
                        {% for p in page_obj.paginator.page_range %}
                            <li class="page-item {% if page_obj.number == p %}active{% endif %}">
                                <a class="page-link pagination-link" href="?page={{ p }}&limit={{ limit }}">{{ p }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>

            <!-- <nav aria-label="Page navigation">
                    <ul class="pagination">
                      {% if page_obj.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&limit={{ limit }}">Previous</a>
                        </li>
                      {% endif %}
                  
                      {% for p in page_range %}
                        <li class="page-item {% if p == page_obj.number %}active{% endif %}">
                          <a class="page-link" href="?page={{ p }}&limit={{ limit }}">{{ p }}</a>
                        </li>
                      {% endfor %}
                  
                      {% if page_obj.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.next_page_number }}&limit={{ limit }}">Next</a>
                        </li>
                      {% endif %}
                    </ul>
            </nav> -->

        </div>

        <div class="d-flex gap-2 justify-content-end">

                <button type="button" id="addRowBtn" class="btn btn-success mt-2">Add Row</button>
                <button type="button" id="saveChangesBtn" class="btn btn-primary mt-2 d-flex ">Save Changes</button>
                
        </div>

    </form>
    {% else %}
        <p class="text-muted">No data found in this table.</p>
    {% endif %}

    <a href="{% url 'view_tables' %}" class="btn btn-secondary mt-3">‚Üê Back to Table List</a>
</div>

{{ columns|json_script:"columns-data" }}

<script>
 document.addEventListener('DOMContentLoaded', function() {
    
    let data_row_id=-1;
    // NEGATIVE ROW ID NUMBER INDICATE THE NEW ROW

    const Datatable=document.getElementById('dataTable');
    const DataTableBody=document.querySelector('#dataTable tbody');
    const paginationNav = document.getElementById("paginationNav");

    const columns = JSON.parse(document.getElementById('columns-data').textContent);
    console.log("Columns :>>>>>>",columns);
    const visibleRows = document.querySelectorAll('#dataTable tbody tr:not([style*="display: none"])');
    console.log("Visible row :",visibleRows)

    let selectedRowIds=[]


    //ASSIG TASK BUTTON TOGGLE
    const AssignTaskBtn = document.querySelector(".AssignTask-btn");
    const taskDiv = document.getElementById("taskDivId");
    const Form=document.getElementById("MainForm");
    const AssignBtn=document.getElementById("AssingId");
    
    
    
    // SHOW/HIDE Display Column Button
    $("#toggleColumnSelector").on("click", function () {        
        const btn = $(this);
        $("#columnSelectorWrapper").slideToggle(300, function () {
            if ($(this).is(":visible")) {
                btn.text("Hide");
            } else {
                btn.text("Show");
            }
        });
    });

    
    // INITIAL LOAD OF ALL COLUMN'S IN DISPLAY COLUMN SELECTION
    columns.forEach(col => {
        //console.log("Column :<> ",col)
        $('#columnSelector').append(`
            <div class="form-check form-check-inline">
                <input class="form-check-input column-toggle" type="checkbox" value="${col}" id="chk_${col}" checked>
                <label class="form-check-label" for="chk_${col}">${col}</label>
            </div>
        `);
    });
    

    console.log("MainForm : ",Form );
    console.log("Assign btn :",AssignBtn);

    AssignBtn.addEventListener("click", function(e) {
            
            console.log("Works!!!")
            e.preventDefault(); // Stop normal form submission
            
            const taskName = document.getElementById("taskName").value;
            const assignedUser = document.getElementById("userSelect").value;

            const checkedBoxes = document.querySelectorAll('.selectDiv input.row-checkbox:checked');
            // Extract their values into an array
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
            console.log("Selected Id's ",selectedIds);

            if(!taskName | !assignedUser){
                alert("fill both TaskName and Assigned User !")    
                return
            }
            console.log("TaskName ",taskName);
            console.log("Assigne User :",assignedUser);
            
            fetch("{% url 'create_task' %}", { 
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCookie("csrftoken") // CSRF token for Django
                },
                body: new URLSearchParams({
                    taskName: taskName,
                    assignedUser: assignedUser,
                    rowIds :selectedIds,
                    tableID :"{{table.id}}"
                })
            })
            .then(response => response.json())
            .then(data => {
                
                alert(data.message);
                if (data.success) {
                    console.log("‚úÖ Task assigned successfully");
                }
            })
            .catch(error => console.error("‚ùå Error:", error));
    });

    let showOnlySelected=false;
    ShowSelRowBtn.addEventListener("click",function(e) {
        
        e.preventDefault();     
        const rows = document.querySelectorAll("#dataTable tbody tr");

            showOnlySelected = !showOnlySelected;  // toggle mode
            if (showOnlySelected) {
                // SHOW ONLY SELECTED ROWS
                rows.forEach(row => {
                    const checkbox = row.querySelector(".row-checkbox");
                    row.style.display = (checkbox && checkbox.checked) ? "" : "none";
                });
            
                ShowSelRowBtn.innerText = "Show All";
            } else {
                // SHOW ALL ROWS
                rows.forEach(row => row.style.display = "");
                ShowSelRowBtn.innerText = "Show Selection";
            }
    });
    
    
    document.addEventListener("click", function(e) {

        if (e.target.classList.contains("SelectAllcls")){

            const selectAllBtn=document.getElementById("SelectAllId");
            console.log("Selelct All Work !!!");
            e.preventDefault();

            console.log("SelecteAll Textcontent |",selectAllBtn.textContent);
            console.log(selectAllBtn.textContent.trim() === "Select All");
            
            
            document.querySelectorAll(".select-row-btn").forEach(function (btn) {
            
                const row = btn.closest("tr");
                if (!row || window.getComputedStyle(row).display === "none") {
                        return; // skip this iteration
                }
                
                const checkbox = row.querySelector(".row-checkbox");
                
                if(selectAllBtn.textContent.trim() === "Select All")
                {   
                    if(!checkbox.checked)   
                        checkbox.checked=true
                }
                else if(selectAllBtn.textContent.trim() === "Deselect All")
                {      
                    if(checkbox.checked)
                        checkbox.checked=false
                }
                // else{
                //     checkbox.checked=!checkbox.checked;
                // }
                
                
                // Toggle checkbox state
                

                // Update button style + text
                if (checkbox.checked) {
                  btn.classList.remove("btn-outline-primary");
                  btn.classList.add("btn-success");
                  btn.textContent = "Selected";
                
                } else {
                  btn.classList.remove("btn-success");
                  btn.classList.add("btn-outline-primary");
                  btn.textContent = "Select";  
                }
            
            });

            if(selectAllBtn.textContent.trim() === "Select All")
            {      
                selectAllBtn.classList.add("btn-success");
                selectAllBtn.classList.remove("btn-outline-primary");
                selectAllBtn.textContent="Deselect All";
            }
            else{
                selectAllBtn.classList.remove("btn-success");
                selectAllBtn.classList.add("btn-outline-primary");
                selectAllBtn.textContent="Select All"
            }

        }    
    });

    function getCookie(name){
            
                let cookieValue = null;
                if ( document.cookie && document.cookie != '' ){
                        let cookies=document.cookie.split(";");
                        for (let cookie of cookies) {
                            cookie = cookie.trim();
                            if (cookie.startsWith(name + "=")) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                }
                console.log("Cookie value :"+cookieValue)
                return cookieValue; 
            
    }

    function updateSelectButton(){

        const selAlldiv=document.querySelector(".selectAllDiv");
        console.log("Select all div style: >> ",selAlldiv.style.display)

    
        if(selAlldiv.style.display==="none"){
            selAlldiv.style.display="block";
         }
         else{
            selAlldiv.style.display="none";
         }

        document.querySelectorAll(".selectDiv").forEach(function (div) {

                if(div.style.display==="none"){
                    div.style.display="block";
                }
                else{
                    div.style.display="none";
                }

        });
    }


    AssignTaskBtn.addEventListener("click", function(event) {

        event.preventDefault();

        if (taskDiv.style.display === "none") {
           taskDiv.style.display = "flex";
           updateSelectButton();
           //AssignTaskBtn.textContent = "Hide Input";
           //AssignTaskBtn.classList.remove("btn-outline-primary");
           //AssignTaskBtn.classList.add("btn-danger");
         } else {
           taskDiv.style.display = "none";
           updateSelectButton();
           // toggleBtn.textContent = "Show Input";
           // toggleBtn.classList.remove("btn-danger");
           // toggleBtn.classList.add("btn-outline-primary");
         }
    
    });

    function attachRowSelectionbtnEvent(){
        // ADD EVENT FOR SELECT BUTTON 
        document.querySelectorAll(".select-row-btn").forEach(function (btn) {

            btn.addEventListener("click", function () {
                const row = btn.closest("tr");
                const checkbox = row.querySelector(".row-checkbox");

                // Toggle checkbox state
                checkbox.checked = !checkbox.checked;
                // Update button style + text
                if (checkbox.checked) {
                  btn.classList.remove("btn-outline-primary");
                  btn.classList.add("btn-success");
                  btn.textContent = "Selected";
                } else {
                  btn.classList.remove("btn-success");
                  btn.classList.add("btn-outline-primary");
                  btn.textContent = "Select";
                }
            });

        });
    }

    attachRowSelectionbtnEvent();
 



    // ADD EVENT FOR 'ADD ROW' BUTTON
    document.getElementById('addRowBtn').addEventListener('click',function(){
            
            tableBody=document.querySelector('#dataTable tbody');

            lastRow=tableBody.querySelector('tr:last-child');
            firstCell_Text=parseInt(lastRow.querySelector('td:first-child').innerText);
            console.log("Last Cell Number :",firstCell_Text)

            const rowElement=document.createElement('tr');
            rowElement.setAttribute("data-row-id",data_row_id);

            //UPDATE THE ROW NUMBER 
            let snum_td=document.createElement('td');    
            snum_td.innerText=firstCell_Text+1
            rowElement.appendChild(snum_td);

            columns.forEach(col => {
                const tableData=document.createElement('td');
                tableData.setAttribute('contenteditable','true');
                tableData.setAttribute('data-field', col);
                rowElement.appendChild(tableData);

            });

            const delBtnTD=document.createElement('td');
            delBtnTD.classList.add("flex-center","gap-1");
            delBtnTD.innerHTML = `<button type="button" class="btn btn-danger btn-sm delete-row-btn">Delete</button>
            <button type="button" class="btn btn-info btn-sm view-row-btn"> View </button>
            <div class="selectDiv" style="display: none;">
                <input type="checkbox" class="row-checkbox d-none" name="selected_rows" value="{{ row.id }}">
                <button type="button" class="btn btn-outline-primary btn-sm select-row-btn"> Select </button>
            </div>`;

            rowElement.appendChild(delBtnTD);

            DataTableBody.appendChild(rowElement);
            data_row_id--;
            //const columns = {{ columns|safe }} ;    //ERROR BECAUSE IT VS CODE EXPECTS 'JS SYNTAX' 
            
    });

    //GOBAL SELECT BUTTON
    $(document).on("click", ".select-row-btn", function () {
        
        const $container = $(this).closest(".selectDiv");
        const $checkbox = $container.find(".row-checkbox");
        const rowId = $checkbox.val();


        if ($checkbox.prop("checked")) {
            // ‚úÖ Select row
            //$checkbox.prop("checked", true);
            selectedRowIds.push(rowId);
            //$(this).text("Selected").removeClass("btn-outline-primary").addClass("btn-primary");
        } else {
            // ‚ùå Unselect row
            //$checkbox.prop("checked", false);
            selectedRowIds = selectedRowIds.filter(id => id !== rowId);
            //$(this).text("Select").removeClass("btn-primary").addClass("btn-outline-primary");
        }

        console.log("Selected Rows:>>>>>>> ", selectedRowIds.join(","));
    });
     

    // NO.ROW DROP AJAX REQUEST TO THE DJANGO
    function loadData(url)
    {   
        console.log("URL : ",url);
        fetch(url, {
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
        .then(res => res.json())
        .then(data => {
                const tbody = document.querySelector("#dataTable tbody");
                let tblhead = document.querySelector("#dataTable thead");
                tblhead.innerHTML=``;
                 
                //RE-CREATE THE TABLE HADERS
                let tableHeaderHtml=`
                    <tr>
                        <td> </td>`

                         data.columns.forEach((col,index) =>{ 
                            let thead_html=`<th>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                        ${col}
                                    </button>
                                    <div class="dropdown-menu p-2" style="max-height:400px; width:auto; overflow:auto;">
                                        
                                        <input type="text" class="form-control mb-2 filter-search" placeholder="Search ${col}">
                                        
                                        <!-- Select All -->
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input filter-select-all" data-col="${index}" checked>
                                            <label class="form-check-label">Select All</label>
                                        </div>

                                        <div class="filter-options-wrapper" style="max-height:180px; overflow:auto;">
                                            <div class="filter-options" data-col="${index}">
                                                <!-- checkboxes will be populated by JS -->
                                            </div>
                                        </div>

                                        <div class="filter-footer mt-2 d-flex justify-content-between border-top pt-2" style="position: sticky; bottom: 0; background: #fff;">
                                            <button class="btn btn-sm btn-primary filter-ok" data-col="{{ forloop.counter0 }}">OK</button>
                                            <button class="btn btn-sm btn-secondary filter-clear" data-col="{{ forloop.counter0 }}">Clear</button>
                                        </div>

                                    </div>
                                </div>
                            </th>`
                            tableHeaderHtml +=thead_html;
                        });
                        
                        //SEL SELECT ALL DIV VISIBLE WHEN THE ASSING TASK DIV IS VISIBLE
                        let selAlldivVisblity=taskDiv.style.display === "flex" ? "flex":"none";

                        //console.log("Task div style |",taskDiv.style.display);
                        //console.log("selAllvisiblity :|",selAlldivVisblity);
                        tableHeaderHtml +=`<th class="flex-center gap-2">Action 
                            <div class="selectAllDiv" style="display: ${selAlldivVisblity};" >
                                <input type="checkbox" class="d-none">
                                <button type="button" id="SelectAllId" class="SelectAllcls btn btn-outline-primary btn-sm w-100 text-nowrap "> Select All</button>
                            </div>
                        </th>

                    </tr>`;
                    
                                                
                    tblhead.innerHTML=tableHeaderHtml;
                    

            // RE-CREATE THE TABLE ROW AFTER 'ROW-DROPDOWN' CHANGE
            tbody.innerHTML = ``;
            let s_num=0;
            data.rows.forEach(row => {
                
                //console.log("Row >> ",row)
                let tr = document.createElement("tr");
                tr.setAttribute("data-row-id",row["id"]);

                const S_no_TD=document.createElement('td');
                S_no_TD.style.color="blue";
                s_num++;
                S_no_TD.textContent=`${s_num}`;
                tr.appendChild(S_no_TD)

                //here
                data.columns.forEach(col => {
                    let td = document.createElement("td");
                    editable=col == "id" ? "false":"true";
                    td.setAttribute("contenteditable", editable);
                    td.setAttribute("data-field", col);
                    td.setAttribute("tabindex", "-1");

                    // handle formatting here
                    td.textContent = formatDateAuto(row[col]);
                    tr.appendChild(td);
                });
                
                let selecDiv= taskDiv.style.display != "none" ? "flex" : "none"
                const isSelected= selectedRowIds.includes(String(row["id"]));
                console.log(`Row ID ${row["id"]} >> Selected Id Exist: ${isSelected}`)

                const ActionBtnTD=document.createElement('td');
                ActionBtnTD.classList.add("flex-center","gap-1");
                ActionBtnTD.innerHTML = `<button type="button" class="btn btn-danger btn-sm delete-row-btn">Delete</button>
            <button type="button" class="btn btn-info btn-sm view-row-btn"> View </button>
            <div class="selectDiv" style="display:${selecDiv};">
                <input type="checkbox" class="row-checkbox d-none" name="selected_rows" value="${row["id"]}" ${isSelected ? "checked" : ""}>
                <button type="button" class="btn ${isSelected ? "btn-success":"btn-outline-primary"} btn-sm select-row-btn"> Select </button>
            </div>`;
                tr.appendChild(ActionBtnTD);

                tbody.appendChild(tr);
                console.log("New Row Feteched !")
            });

            // update pagination nav
            let paginationHTML = `<ul class="pagination">`;
            for (let p = 1; p <= data.total_pages; p++) {
                paginationHTML += `
                    <li class="page-item ${data.current_page === p ? "active" : ""}">
                        <a class="page-link pagination-link" href="?page=${p}&limit=${data.limit}">${p}</a>
                    </li>`;
            }
            paginationHTML += `</ul>`;
            paginationNav.innerHTML = paginationHTML;
            
            attachPaginationEvents(); // reattach click events
            attachRowSelectionbtnEvent();
            buildColumnFilters();

            console.log("SELECTED ROW ID'S AFTER URL > ",selectedRowIds)
        });
    
    }

    document.getElementById("colSelAplyBtn_Id").addEventListener("click", function() {
    
        selecteColValues=[...document.querySelectorAll("#columnSelector input:checked")].map(ck => ck.value);
        let limit= document.getElementById("rowLimit").value;
        console.log("Limit :>>>",limit);

        const url = `${window.location.pathname}?limit=${limit}&page=1&displayColumn=${selecteColValues}`;
        console.log("Selected COlumns >>> ",selecteColValues);
        
        loadData(url)
        
    });

    document.getElementById("rowLimit").addEventListener("change", function() {
    
        const limit = this.value;

        selecteColValues=[...document.querySelectorAll("#columnSelector input:checked")].map(ck => ck.value)
        const url = `${window.location.pathname}?limit=${limit}&page=1&displayColumn=${selecteColValues}`;
        console.log("Selected COlumns >>> ",selecteColValues);
        
        loadData(url)
        
    });

    // Handle pagination links via AJAX
    function attachPaginationEvents() {
        document.querySelectorAll(".pagination-link").forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const url = this.getAttribute("href");
                loadData(url);
            });
        });
    }

    attachPaginationEvents();


    function formatDateAuto(value) {
        
        // If it's a date string like 2025-08-25
        if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
            const [y, m, d] = value.split("-");
            return `${d}-${m}-${y}`;
        }
        
        return value; // fallback for plain text
    }


    // SAVE CHANGE ON THE TABLE USING AJAX POST 
    document.getElementById('saveChangesBtn').addEventListener('click', function() {
            
            const rows = document.querySelectorAll('tbody tr');
            let updatedData = [];

        rows.forEach(row => {
            
            const rowId = row.getAttribute('data-row-id');
            let rowData = { id: rowId };
        
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.getAttribute('data-field');
                const value = cell.innerText.trim();
                rowData[field] = value;
            });
        
            updatedData.push(rowData);
        });

        
    // Send AJAX POST to Django
    fetch("{% url 'update_table_data' table_name=table.table_name %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ rows: updatedData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Data updated successfully!');
        } else {
            alert('Error updating data.');
        }
    });
});

    // EVENT DELGATION FOR DELETE BUTTON
    document.addEventListener('click', function(event) {
        
        if (event.target.classList.contains('delete-row-btn')) {    
            
            const row = event.target.closest('tr');
            const rowId = row.getAttribute('data-row-id');
            const confirmation=confirm('Are you sure you want to delete this row?')
            if (rowId > 0 && confirmation) {
                // Existing DB row - send delete to backend
                fetch("{% url 'delete_table_row' table_name=table.table_name %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ id: rowId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        row.remove();
                    } else {
                        alert('Failed to delete row.');
                    }
                });
            } if(confirmation){
            
                // New row (just remove from DOM)
                row.remove();
            }
        }
    });

// EVENT DELEGATION FOR VIEW
document.addEventListener("click", function(e) {
    
    if (e.target.classList.contains("view-row-btn")) {
        
        const row = event.target.closest('tr');
        const rowId = row.getAttribute('data-row-id');

        const tableName ="{{ table.table_name }}"// add table name in HTML
        console.log("Table Name :",tableName,"RowId ",rowId);
        
        window.location.href = `/table_data/view_row_data/${tableName}/${rowId}/`; // Redirect to new page
    }
});

document.addEventListener("click", function(e) {
    
    if (e.target.classList.contains("add-Item-btn")) {

        e.preventDefault();
        const rowId ="-1";
        const tableName ="{{ table.table_name }}"// add table name in HTML
        console.log("Table Name :",tableName,"RowId ",rowId);

        const url = `/table_data/view_row_data/${tableName}/${rowId}/`;

        console.log("Redirecting to:", url);
        window.location.href = url;

        
        //window.location.href = `/table_data/view_row_data/${tableName}/${rowId}/`; 
        
    }

});

//--FILTER --//
function buildColumnFilters() {
    const rows = document.querySelectorAll("#dataTable tbody tr");
    const colCount = document.querySelectorAll("#dataTable thead tr:first-child th").length - 2; // exclude # and Action
    console.log("COl Cound >",colCount)

    for (let c = 0; c <= colCount; c++) {
        const values = new Set();
        rows.forEach(row => {
            const cell = row.querySelectorAll("td")[c + 1]; // +1 for row number
            if (cell) values.add(cell.innerText.trim());
        });

        // console.log("Unique Row Data : ",values)
        const container = document.querySelector(`.filter-options[data-col="${c}"]`);
        
        let filterHtml="";
        [...values].sort().forEach(val => {
            filterHtml += `
                <div class="text-nowrap">
                    <input type="checkbox" id="${val}"_id class="form-check-input filter-checkbox" data-col="${c}" value="${val}" checked>
                    <label class="form-check-label" for="${val}"_id >${val}</label>
                </div>`;
        });
        container.innerHTML =filterHtml;
    }
}

// FIND THE UNIQUE VALUE AND BUILD THE COLUMN FILTER TO THE EACH COLUMN
buildColumnFilters()
    function applyFilters() {

        const rows = document.querySelectorAll("#dataTable tbody tr");

        // 1. Pre-read all filters once (instead of reading inside each row)
        const filters = [];
        document.querySelectorAll(".filter-options").forEach(container => {
            const col = parseInt(container.dataset.col);
            const selected = new Set(
                [...container.querySelectorAll(".filter-checkbox:checked")]
                    .map(cb => cb.value)
            );
            filters.push({ col, selected });
        });

        // 2. Loop rows only once
        rows.forEach(row => {
            let visible = true;
            const cells = row.children; // faster than querySelectorAll

            // 3. Apply all filters quickly
            for (const f of filters) {
                if (f.selected.size === 0) continue; // no filter applied for this column

                const cell = cells[f.col + 1]; // +1 due to row number
                if (!cell) continue;

                const value = cell.textContent.trim();

                if (!f.selected.has(value)) {
                    visible = false;
                    break;   // üöÄ stop checking other columns (huge speed boost)
                }
            }
    
            row.style.display = visible ? "" : "none";
        });
    }


// function applyFilters(){

//     const table_row=document.querySelectorAll("#dataTable tbody tr");
//     table_row.forEach( row =>{
//         let visible=true;
//         document.querySelectorAll(".filter-options").forEach( filterContainter =>{
            
//             colIndex=parseInt(filterContainter.getAttribute("data-col"));
//             cellValue=row.querySelectorAll("td")[colIndex+1];

//             checked_values=[...filterContainter.querySelectorAll(".filter-checkbox:checked")].map(cb => cb.value);
//             if (cellValue && checked_values.length > 0 && !checked_values.includes( cellValue.innerText.trim() ) ){
//                 visible=false
//             }

//         });
//         row.style.display=visible ? "":"none";
        
//     });

// }


// ADD EVENT FOR FILTER 'CHECK BOX'
document.addEventListener("click", function(e) {
    
    if (e.target.classList.contains("filter-ok")) {
        e.preventDefault();
        applyFilters();
    }

});

// SELECT ALL / UNSELECT ALL
document.addEventListener("change", function(e) {
    if (e.target.classList.contains("filter-select-all")) {
        const col = e.target.dataset.col;
        const checked = e.target.checked;

        document.querySelectorAll(
            `.filter-options[data-col="${col}"] .filter-checkbox`
        ).forEach(cb => cb.checked = checked);
    }
});


// CLEAR button ‚Üí uncheck all checkboxes of that column
document.addEventListener("click", function (e) {
    if (e.target.classList.contains("filter-clear")) {
        e.preventDefault();
        const col = e.target.dataset.col;
        document.querySelectorAll(`.filter-options[data-col="${col}"] .filter-checkbox`)
        .forEach(cb => cb.checked = false);

        applyFilters();
    }
});


// ADD ONLY THE SEARCH TEXT TO THE LISTBOX
document.addEventListener("input", function(e) {

    if (e.target.classList.contains("filter-search")) {

        const searchText = e.target.value.toLowerCase();
        const container=e.target.closest(".dropdown-menu");

         
        console.log("Next Element Sibili : > ",container);
        container.querySelectorAll(".filter-options-wrapper div").forEach(div => {
            const checkbox = div.querySelector(".filter-checkbox");
            //console.log("CHEck box :",checkbox);
            const label = div.innerText.toLowerCase();
            console.log("label ",label);

            if(label.includes(searchText)){
                checkbox.checked=true;
            }
            else{
                checkbox.checked=false;
            }
            //div.style.display = label.includes(searchText) ? "" : "none";
        });
    }

});



//-- NAVIGATION CURSOR --//
const table = document.getElementById('dataTable');

let activeCell = null;

table.addEventListener('keydown', function (e) {
    
    const selected_key=e.key
    console.log("SELECTED KEY : "+selected_key)

    if (selected_key === 'F2' && activeCell && activeCell.hasAttribute('data-field') ) {
        
        console.log("F2 PRESSED : "+selected_key);
        console.log("Item : "+activeCell.hasAttribute('data-field'));
        e.preventDefault();
        activeCell.removeAttribute('tabindex');
        activeCell.setAttribute('contenteditable','true');
        console.log("Active cell F2 ", activeCell);
        activeCell.focus();
        return;
    }
    
    const td = e.target.closest('td');
    if (!td ) return;

    const currentCell = td;
    console.log("Current Cell "+currentCell)

    const currentRow = currentCell.parentElement;
    console.log("ParentElement "+currentRow)

    const rowIndex = Array.from(table.rows).indexOf(currentRow);
    const cellIndex = Array.from(currentRow.cells).indexOf(currentCell);

    
    let targetCell = null;

    if (selected_key === 'ArrowRight') {
        if (cellIndex < currentRow.cells.length - 1) {
            targetCell = currentRow.cells[cellIndex + 1];
        }
    } else if (selected_key === 'ArrowLeft') {
        if (cellIndex > 0) {
            targetCell = currentRow.cells[cellIndex - 1];
        }
    } else if (selected_key === 'ArrowDown') {
        if (rowIndex < table.rows.length - 1) {
            targetCell = table.rows[rowIndex + 1].cells[cellIndex];
        }
    } else if (selected_key === 'ArrowUp') {
        if (rowIndex > 0) {
            if (rowIndex - 1 === 0){
                return;
            }
            targetCell = table.rows[rowIndex - 1].cells[cellIndex];
        }
    }
    if (targetCell) {
        console.log("Targeted cell After Key Press :", targetCell);
        e.preventDefault();  // Prevent arrow key from moving caret inside contenteditable
        highlightCell(targetCell);      
    }

});


function highlightCell(cell) {
    if (activeCell) {
         activeCell.classList.remove('highlight');
         activeCell.removeAttribute('contenteditable');
         activeCell.setAttribute('tabindex', '-1');
    }
    activeCell = cell;
    activeCell.classList.add('highlight');
    activeCell.setAttribute('tabindex', '-1');
    activeCell.setAttribute('contenteditable', 'false');
    activeCell.focus();

}


function focusCellWithoutCaret(cell) {
    if (activeCell) {
        activeCell.removeAttribute('contenteditable');
    }
    activeCell = cell;
    console.log("Active cell changed to: ", activeCell);
    activeCell.setAttribute('tabindex', '-1');  // Ensure it can be focused
    activeCell.focus();
    activeCell.blur();  // Remove caret
    activeCell.classList.add('highlight');  // Optional: Add visual highlight
}

function placeCaretAtEnd(el) {
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(el);
    range.collapse(false);  // Collapse to end of content
    sel.removeAllRanges();
    sel.addRange(range);
}

});

</script>
<style>
.highlight {
    outline: 2px solid blue;
    background-color: #e6f7ff;
}
</style>
{% endblock %}
