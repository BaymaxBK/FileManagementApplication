{% extends "base.html" %}
{% load custom_tags %}

{% block title %} {{ table.display_name }} - Data{% endblock %}

{% block content %}
<div class="container mt-4">
    <h4 class="mb-3">{{ table.display_name }} <small class="text-muted">({{ table.table_name }})</small></h4>

    {% if rows %}
    <form id="saveChangesForm" method="get">

        <div class="d-flex justify-content-end align-items-center mb-3">
            <label for="rowLimit" class="form-label px-3">Rows per page:</label>
            <select name="limit" id="rowLimit" class="form-select w-auto mx-3" >
                <option value="5" {% if limit == 5 %}selected{% endif %}>5</option>
                <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if limit == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
                <option value="1000" {% if limit == 1000 %}selected{% endif %}>1000</option>
                <option value="2000" {% if limit == 2000 %}selected{% endif %}>2000</option>
            </select>
            <button id="addItemBtn" class="btn btn-success add-Item-btn">+ Add Item</button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover text-center" id="dataTable">
                <thead class="table-light">
                    <tr>
                        <td> </td>
                        
                        {% for col in columns %}
                            <th>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                        {{ col }}
                                    </button>
                                    <div class="dropdown-menu p-2" style="max-height:200px; overflow:auto;">
                                        <input type="text" class="form-control mb-2 filter-search" placeholder="Search {{ col }}">
                                        <div class="filter-options" data-col="{{ forloop.counter0 }}">
                                            <!-- checkboxes will be populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </th>
                        {% endfor %}
                        <th>Action</th>

                    </tr>

                </thead>
                <tbody>
                    {% for row in rows %}
                        <tr data-row-id="{{ row.id }}">
                            <td>{{ forloop.counter }}</td>
                            {% for col in columns %}
                                <td contenteditable="true" data-field="{{ col }}" tabindex="-1">{{ row|get_item:col|format_date_auto }}</td>
                            {% endfor %}

                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row-btn">Delete</button>
                                <button type="button" class="btn btn-info btn-sm view-row-btn"> View </button>
                            </td>

                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <nav id="paginationNav">
                <ul class="pagination">
                    {% for p in page_obj.paginator.page_range %}
                        <li class="page-item {% if page_obj.number == p %}active{% endif %}">
                            <a class="page-link pagination-link" href="?page={{ p }}&limit={{ limit }}">{{ p }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </nav>

            <!-- <nav aria-label="Page navigation">
                    <ul class="pagination">
                      {% if page_obj.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&limit={{ limit }}">Previous</a>
                        </li>
                      {% endif %}
                  
                      {% for p in page_range %}
                        <li class="page-item {% if p == page_obj.number %}active{% endif %}">
                          <a class="page-link" href="?page={{ p }}&limit={{ limit }}">{{ p }}</a>
                        </li>
                      {% endfor %}
                  
                      {% if page_obj.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.next_page_number }}&limit={{ limit }}">Next</a>
                        </li>
                      {% endif %}
                    </ul>
            </nav> -->

        </div>

        <div class="d-flex gap-2 justify-content-end">

            <button type="button" id="addRowBtn" class="btn btn-success mt-2">Add Row</button>
            <button type="button" id="saveChangesBtn" class="btn btn-primary mt-2 d-flex ">Save Changes</button>

        </div>

    </form>
    {% else %}
        <p class="text-muted">No data found in this table.</p>
    {% endif %}

    <a href="{% url 'view_tables' %}" class="btn btn-secondary mt-3">‚Üê Back to Table List</a>
</div>

{{ columns|json_script:"columns-data" }}

<script>
 document.addEventListener('DOMContentLoaded', function() {
    
    let data_row_id=-1;
    // NEGATIVE ROW ID NUMBER INDICATE THE NEW ROW

    const Datatable=document.getElementById('dataTable');
    const DataTableBody=document.querySelector('#dataTable tbody');
    const paginationNav = document.getElementById("paginationNav");

    const columns = JSON.parse(document.getElementById('columns-data').textContent);
    console.log("Columns :>>>>>>",columns);

    // ADD EVENT FOR 'ADD ROW' BUTTON
    document.getElementById('addRowBtn').addEventListener('click',function(){
            
            tableBody=document.querySelector('#dataTable tbody');

            lastRow=tableBody.querySelector('tr:last-child');
            firstCell_Text=parseInt(lastRow.querySelector('td:first-child').innerText);
            console.log("Last Cell Number :",firstCell_Text)

            const rowElement=document.createElement('tr');
            rowElement.setAttribute("data-row-id",data_row_id);

            //UPDATE THE ROW NUMBER 
            let snum_td=document.createElement('td');    
            snum_td.innerText=firstCell_Text+1
            rowElement.appendChild(snum_td);

            columns.forEach(col => {
                const tableData=document.createElement('td');
                tableData.setAttribute('contenteditable','true');
                tableData.setAttribute('data-field', col);
                rowElement.appendChild(tableData);

            });
            const delBtnTD=document.createElement('td');
            delBtnTD.innerHTML = `<button type="button" class="btn btn-danger btn-sm delete-row-btn">Delete</button>
            <button type="button" class="btn btn-info btn-sm view-row-btn">
                View
            </button>`;
            rowElement.appendChild(delBtnTD);

            DataTableBody.appendChild(rowElement);
            data_row_id--;
            //const columns = {{ columns|safe }} ;    //ERROR BECAUSE IT VS CODE EXPECTS 'JS SYNTAX' 
            
    });

    

    // NO.ROW DROP AJAX REQUEST TO THE DJANGO
    function loadData(url)
    {
        fetch(url, {
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
        .then(res => res.json())
        .then(data => {
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = "";
        let s_num=0;
            data.rows.forEach(row => {
                
                //console.log("Row >> ",row)
                let tr = document.createElement("tr");
                tr.setAttribute("data-row-id",row["id"])

                const S_no_TD=document.createElement('td');
                s_num++;
                S_no_TD.textContent=`${s_num}`;
                tr.appendChild(S_no_TD)

                //here
                data.columns.forEach(col => {
                    let td = document.createElement("td");
                    td.setAttribute("contenteditable", "true");
                    td.setAttribute("data-field", col);
                    td.setAttribute("tabindex", "-1");

                    // handle formatting here
                    td.textContent = formatDateAuto(row[col]);
                    tr.appendChild(td);
                });

                const ActionBtnTD=document.createElement('td');
                ActionBtnTD.innerHTML = `<button type="button" class="btn btn-danger btn-sm delete-row-btn">Delete</button>
            <button type="button" class="btn btn-info btn-sm view-row-btn">
                View
            </button>`;
                tr.appendChild(ActionBtnTD);

                tbody.appendChild(tr);
            });
            // update pagination nav
            let paginationHTML = `<ul class="pagination">`;
            for (let p = 1; p <= data.total_pages; p++) {
                paginationHTML += `
                    <li class="page-item ${data.current_page === p ? "active" : ""}">
                        <a class="page-link pagination-link" href="?page=${p}&limit=${data.limit}">${p}</a>
                    </li>`;
            }
            paginationHTML += `</ul>`;
            paginationNav.innerHTML = paginationHTML;
            
            attachPaginationEvents(); // reattach click events

        });
    
    }


    document.getElementById("rowLimit").addEventListener("change", function() {
    
        const limit = this.value;
        const url = `${window.location.pathname}?limit=${limit}&page=1`;
        loadData(url)
        
    });

    // Handle pagination links via AJAX
    function attachPaginationEvents() {
        document.querySelectorAll(".pagination-link").forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const url = this.getAttribute("href");
                loadData(url);
            });
        });
    }

    attachPaginationEvents();


    function formatDateAuto(value) {
        
        // If it's a date string like 2025-08-25
        if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
            const [y, m, d] = value.split("-");
            return `${d}-${m}-${y}`;
        }
        
        return value; // fallback for plain text
    }


    // SAVE CHANGE ON THE TABLE USING AJAX POST 
    document.getElementById('saveChangesBtn').addEventListener('click', function() {
            
            const rows = document.querySelectorAll('tbody tr');
            let updatedData = [];

        rows.forEach(row => {
            
            const rowId = row.getAttribute('data-row-id');
            let rowData = { id: rowId };
        
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.getAttribute('data-field');
                const value = cell.innerText.trim();
                rowData[field] = value;
            });
        
            updatedData.push(rowData);
        });

        
    // Send AJAX POST to Django
    fetch("{% url 'update_table_data' table_name=table.table_name %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ rows: updatedData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Data updated successfully!');
        } else {
            alert('Error updating data.');
        }
    });
});

    // EVENT DELGATION FOR DELETE BUTTON
    document.addEventListener('click', function(event) {
        
        if (event.target.classList.contains('delete-row-btn')) {    
            
            const row = event.target.closest('tr');
            const rowId = row.getAttribute('data-row-id');
            const confirmation=confirm('Are you sure you want to delete this row?')
            if (rowId > 0 && confirmation) {
                // Existing DB row - send delete to backend
                fetch("{% url 'delete_table_row' table_name=table.table_name %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ id: rowId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        row.remove();
                    } else {
                        alert('Failed to delete row.');
                    }
                });
            } if(confirmation){
            
                // New row (just remove from DOM)
                row.remove();
            }
        }
    });

// EVENT DELEGATION FOR VIEW
document.addEventListener("click", function(e) {
    
    if (e.target.classList.contains("view-row-btn")) {
        
        const row = event.target.closest('tr');
        const rowId = row.getAttribute('data-row-id');

        const tableName ="{{ table.table_name }}"// add table name in HTML
        console.log("Table Name :",tableName,"RowId ",rowId);
        
        window.location.href = `/table_data/view_row_data/${tableName}/${rowId}/`; // Redirect to new page
    }
});

document.addEventListener("click", function(e) {
    
    if (e.target.classList.contains("add-Item-btn")) {

        e.preventDefault();
        const rowId ="-1";
        const tableName ="{{ table.table_name }}"// add table name in HTML
        console.log("Table Name :",tableName,"RowId ",rowId);

        const url = `/table_data/view_row_data/${tableName}/${rowId}/`;

        console.log("Redirecting to:", url);
        window.location.href = url;

        
        //window.location.href = `/table_data/view_row_data/${tableName}/${rowId}/`; 
        
    }

});

//--FILTER --//
function buildColumnFilters() {
    const rows = document.querySelectorAll("#dataTable tbody tr");
    const colCount = document.querySelectorAll("#dataTable thead tr:first-child th").length - 2; // exclude # and Action

    for (let c = 0; c <= colCount; c++) {
        const values = new Set();
        rows.forEach(row => {
            const cell = row.querySelectorAll("td")[c + 1]; // +1 for row number
            if (cell) values.add(cell.innerText.trim());
        });
        console.log("Unique Row Data : ",values)
        const container = document.querySelector(`.filter-options[data-col="${c}"]`);
        container.innerHTML = "";
        [...values].sort().forEach(val => {
            container.innerHTML += `
                <div>
                    <input type="checkbox" class="form-check-input filter-checkbox" data-col="${c}" value="${val}" checked>
                    <label class="form-check-label">${val}</label>
                </div>`;
        });
    }
}

// FIND THE UNIQUE VALUE AND BUILD THE COLUMN FILTER TO THE EACH COLUMN
buildColumnFilters()

function applyFilters(){

    const table_row=document.querySelectorAll("#dataTable tbody tr");
    table_row.forEach( row =>{
        let visible=true;
        document.querySelectorAll(".filter-options").forEach( filterContainter =>{
            
            colIndex=parseInt(filterContainter.getAttribute("data-col"));
            cellValue=row.querySelectorAll("td")[colIndex+1];

            checked_values=[...filterContainter.querySelectorAll(".filter-checkbox:checked")].map(cb => cb.value);
            if (cellValue && checked_values.length > 0 && !checked_values.includes( cellValue.innerText.trim() ) ){
                visible=false
            }

        });
        row.style.display=visible ? "":"none";

    });


}


// ADD EVENT FOR FILTER 'CHECK BOX'
document.addEventListener("change", function(e) {
    
    if (e.target.classList.contains("filter-checkbox")) {
        applyFilters();
    }

});  


// ADD ONLY THE SEARCH TEXT TO THE LISTBOX
document.addEventListener("input", function(e) {

    if (e.target.classList.contains("filter-search")) {
        const searchText = e.target.value.toLowerCase();
        const container = e.target.nextElementSibling;
        container.querySelectorAll("div").forEach(div => {
            const label = div.innerText.toLowerCase();
            div.style.display = label.includes(searchText) ? "" : "none";
        });
    }

});



//-- NAVIGATION CURSOR --//
const table = document.getElementById('dataTable');

let activeCell = null;

table.addEventListener('keydown', function (e) {
    
    const selected_key=e.key
    console.log("SELECTED KEY : "+selected_key)

    if (selected_key === 'F2' && activeCell && activeCell.hasAttribute('data-field') ) {
        
        console.log("F2 PRESSED : "+selected_key);
        console.log("Item : "+activeCell.hasAttribute('data-field'));
        e.preventDefault();
        activeCell.removeAttribute('tabindex');
        activeCell.setAttribute('contenteditable','true');
        console.log("Active cell F2 ", activeCell);
        activeCell.focus();
        return;
    }
    
    const td = e.target.closest('td');
    if (!td ) return;

    const currentCell = td;
    console.log("Current Cell "+currentCell)

    const currentRow = currentCell.parentElement;
    console.log("ParentElement "+currentRow)

    const rowIndex = Array.from(table.rows).indexOf(currentRow);
    const cellIndex = Array.from(currentRow.cells).indexOf(currentCell);

    
    let targetCell = null;

    if (selected_key === 'ArrowRight') {
        if (cellIndex < currentRow.cells.length - 1) {
            targetCell = currentRow.cells[cellIndex + 1];
        }
    } else if (selected_key === 'ArrowLeft') {
        if (cellIndex > 0) {
            targetCell = currentRow.cells[cellIndex - 1];
        }
    } else if (selected_key === 'ArrowDown') {
        if (rowIndex < table.rows.length - 1) {
            targetCell = table.rows[rowIndex + 1].cells[cellIndex];
        }
    } else if (selected_key === 'ArrowUp') {
        if (rowIndex > 0) {
            if (rowIndex - 1 === 0){
                return;
            }
            targetCell = table.rows[rowIndex - 1].cells[cellIndex];
        }
    }
    if (targetCell) {
        console.log("Targeted cell After Key Press :", targetCell);
        e.preventDefault();  // Prevent arrow key from moving caret inside contenteditable
        highlightCell(targetCell);      
    }

});


function highlightCell(cell) {
    if (activeCell) {
         activeCell.classList.remove('highlight');
         activeCell.removeAttribute('contenteditable');
         activeCell.setAttribute('tabindex', '-1');
    }
    activeCell = cell;
    activeCell.classList.add('highlight');
    activeCell.setAttribute('tabindex', '-1');
    activeCell.setAttribute('contenteditable', 'false');
    activeCell.focus();

}


function focusCellWithoutCaret(cell) {
    if (activeCell) {
        activeCell.removeAttribute('contenteditable');
    }
    activeCell = cell;
    console.log("Active cell changed to: ", activeCell);
    activeCell.setAttribute('tabindex', '-1');  // Ensure it can be focused
    activeCell.focus();
    activeCell.blur();  // Remove caret
    activeCell.classList.add('highlight');  // Optional: Add visual highlight
}

function placeCaretAtEnd(el) {
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(el);
    range.collapse(false);  // Collapse to end of content
    sel.removeAllRanges();
    sel.addRange(range);
}

});

</script>
<style>
.highlight {
    outline: 2px solid blue;
    background-color: #e6f7ff;
}
</style>
{% endblock %}
