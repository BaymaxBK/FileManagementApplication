{% extends "base.html" %}
{% load static %}

{% block title %}Assingned Tasks{% endblock %}

<!DOCTYPE html>
<html>
<head>
    <title>{{ table.TaskNameDisplay }}</title>
    <link href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <style>
        #dataTable thead select {
            width: 100%;
            min-width: 100px;
        }
        #dataTable thead input {
            width: 100%;
        }
        #dataTable td{
            text-wrap: nowrap;
        }
            
         /* Filter Row */
        #excelFilterRow th {
            position: relative;
            background: #f8f9fa;
            padding: 2px;
        }

        /* Dropdown Styles */
        .filter-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            z-index: 1000;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            min-width: 400px;
            max-height: 370px;
            overflow-y: auto;
            padding: 18px;
        }

        .filter-btn {
            background: #fff;
            border: 1px solid #ced4da;
            font-size: 14px;
            padding: 10px 5px;
            border-radius: 5px;
            width: 100%;
            text-align:left;
        }

        .filter-btn i {
            float:right;
        }

        .filter-dropdown .form-check {
            font-size: 16px;
        }

        .apply-clear-buttons {
            border-top: 1px solid #eee;
            margin-top: 5px;
            padding-top: 5px;
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }

        #columnSelector .form-check {
            display: inline-block;
            margin-right: 10px;
        }
            
    </style>

</head>
<body>

{% block content %}
    <style>
        #dataTable thead select {
            width: 100%;
            min-width: 100px;
        }
        #dataTable thead input {
            width: 100%;
        }
        #dataTable td{
            text-wrap: nowrap;
        }
            
         /* Filter Row */
        #excelFilterRow th {
            position: relative;
            background: #f8f9fa;
            padding: 2px;
        }

        /* Dropdown Styles */
        .filter-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            z-index: 1000;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            min-width: 400px;
            max-height: 370px;
            overflow-y: auto;
            padding: 18px;
        }

        .filter-btn {
            background: #fff;
            border: 1px solid #ced4da;
            font-size: 14px;
            padding: 10px 5px;
            border-radius: 5px;
            width: 100%;
            text-align:left;
        }

        .filter-btn i {
            float:right;
        }

        .filter-dropdown .form-check {
            font-size: 16px;
        }

        .apply-clear-buttons {
            border-top: 1px solid #eee;
            margin-top: 5px;
            padding-top: 5px;
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }

        #columnSelector .form-check {
            display: inline-block;
            margin-right: 10px;
        }

        
        .editable-cell {
            outline: none;
        }
        .editable-cell-updated {
            background: #d4edda !important;
            transition: 0.5s;
        }
            
    </style>

    <div class="container mt-3">
        <div class="row mb-2">
            
            <div class="col">
                <h4>Display Columns</h4>
            </div>

            <div class="col text-end">
                <button id="toggleColumnSelector" class="btn btn-secondary btn-sm me-2">Show</button>
            </div>

            <div id="columnSelectorWrapper" style="display: none;">
                <div id="columnSelector" class="mb-3"></div>
                
                <div class="text-end">
                    <button id="applyColumns" class="col btn btn-primary btn-sm">Apply Columns</button>
                </div>
            </div>
        </div>
    </div>
  
    <hr>

    <h3>Task name : <code>{{ table.TaskNameDisplay }}</code></h3>
    
    <table id="dataTable" class="table table-striped table-bordered table-hover w-100" style="width:100%">        
        <thead>
            <tr id="headerRow">
                <!-- Column headers will load dynamically -->
            </tr>
            <tr id="excelFilterRow"></tr>
            <tr id="filterRow" class="mb-3"></tr>
        </thead>
              
    </table>
</body>

<script>

        let table;
        function setupColWiseFilterDropdownHandlers() {
        // all the delegated event handlers go here (the block above)
        // âœ… Dropdown toggle handler
            $(document).on('click', '.filter-btn', function (e) {
                e.stopPropagation();
                $('.filter-dropdown').not($(this).siblings('.filter-dropdown')).hide();
                $(this).siblings('.filter-dropdown').toggle();
            });
                
            // âœ… Hide dropdowns when clicking outside
            $(document).on('click', function () {
                $('.filter-dropdown').hide();
            });
        
            // âœ… Prevent closing dropdown on inside click
            $(document).on('click', '.filter-dropdown', function (e) {
                e.stopPropagation();
            });

                    
            // âœ… Apply filter
            $(document).on('click', '.apply-filter', function () {
                const dropdown = $(this).closest('.filter-dropdown');
                const checkboxes = dropdown.find('.column-filter');
                const colIndex = checkboxes.first().data('col-index')
                const selected = checkboxes.filter(':checked').map(function () {
                                            return $(this).val();
                                }).get();

                console.log("Selected Items :",selected," COlumn in Index: ",colIndex);
                const regex = selected.length ? '^(' + selected.join('|') + ')$' : '';
                table.column(colIndex).search(regex, true, false).draw();

                dropdown.hide();
            });

                    // âœ… Clear filter
            $(document).on('click', '.clear-filter', function () {
                const dropdown = $(this).closest('.filter-dropdown');
                const checkboxes = dropdown.find('.column-filter');
                const colIndex = checkboxes.first().data('col-index');
                checkboxes.prop('checked', false);
                table.column(colIndex).search('').draw();
                dropdown.hide();
            });

        }

        $(document).ready(function() {
            
            const tableId = "{{ table.id }}";
            
            let allColumns = [];
            let selectedColumns = [];
            
            // SET THE EVENT HANDLERS FOR COLUM WISE FILTER DROPDOWN AND TEXT BOX'S 
            setupColWiseFilterDropdownHandlers();

            // SHOW/HIDE Display Column Button
            $("#toggleColumnSelector").on("click", function () {        
                const btn = $(this);

                $("#columnSelectorWrapper").slideToggle(300, function () {
                    if ($(this).is(":visible")) {
                        btn.text("Hide");
                    } else {
                        btn.text("Show");
                    }
                });
            });

            // Fetch column names dynamically first
            $.getJSON(`/task_table/${tableId}/data/?length=1`, function(initData) {
                    
                    if (initData.data.length == 0) {
                        $('#dataTable').html('<p>No data found</p>');
                    }
                    
                    allColumns = Object.keys(initData.data[0])
                    
                    console.log("Column Name :> ", initData.columns);
                    console.log("Column Name Disp:> ", initData.displayColumn);
                    console.log("All Columns : ",allColumns)

        
                    allColumns.forEach(col => {
                        
                        //console.log("Column :<> ",col)
                        $('#columnSelector').append(`
                            <div class="form-check form-check-inline">
                                <input class="form-check-input column-toggle" type="checkbox" value="${col}" id="chk_${col}" checked>
                                <label class="form-check-label" for="chk_${col}">${col}</label>
                            </div>
                        `);

                    });

        
                    // Default: all columns selected
                    selectedColumns = [...allColumns];            
                    renderTable();

                    // Step 4: When â€œApply Columnsâ€ clicked â†’ re-render
                    $('#applyColumns').on('click', function() {
                        
                        selectedColumns = $('.column-toggle:checked').map(function() {
                            return $(this).val();
                        }).get();


                        if ($.fn.DataTable.isDataTable('#dataTable')) {
                                $('#dataTable').DataTable().clear().destroy();
                                $('#dataTable thead').empty(); // âœ… important
                        }
                        renderTable();
                    });
                    
                
                
            });
            
            function renderTable(){

                $('#headerRow, #filterRow ,#excelFilterRow').empty();
                    
                    console.log("Selected Col in Render : ",selectedColumns);
                    
                    const columns=selectedColumns.map(col => (
                        {
                            data: col,title:col
                        }
                    ));

                    $('#dataTable thead').html(`
                        <tr id="headerRow"></tr>
                        <tr id="excelFilterRow"></tr>
                        <tr id="filterRow"></tr>
                    `);

                    columns.forEach(col => {

                        $('#headerRow').append(`<th>${col.title}</th>`);
                        $('#excelFilterRow').append(`
                                <th>
                                    <div class="filter-wrapper position-relative">
                                        <button class="filter-btn" data-col="${col.title}">
                                            ${col.title}<i class="bi bi-chevron-down"></i>
                                        </button>
                                        <div class="filter-dropdown">
                                            <div class="checkbox-list"></div>
                                            <div class="apply-clear-buttons">
                                                <button class="btn btn-sm btn-primary apply-filter">Apply</button>
                                                <button class="btn btn-sm btn-secondary clear-filter">Clear</button>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                        `);
                        $('#filterRow').append(
                            `<th><input type="text" class="form-control form-control-sm column-filter" placeholder="Search ${col.title}" /></th>`
                        );

                    });


                    // Initialize DataTable
                    table = $('#dataTable').DataTable({
                        
                        processing: true,
                        serverSide: true,
                        ajax:{ 
                            url:`/task_table/${tableId}/data/`,
                            data: function(d) {
                                // Send selected columns to backend
                                d.selected_columns = selectedColumns;
                            }           
                        },
                        columns: columns,
                        pageLength: 25,
                        lengthMenu: [ [10, 25, 50, 100, 250, 500,1000,2000,5000,-1], [10, 25, 50, 100, 250, 500,1000,2000,5000,"All"] ],
                        orderCellsTop: true,
                        responsive: true,
                        language: {
                            searchPlaceholder: "Global search...",
                            search: "",
                        },
                        dom: "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                             "<'row'<'col-sm-12'tr>>" +
                             "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                        
                        createdRow: function (row, data, dataIndex) {
                            // Make all cells editable except the ID column
                            $(row).find('td').each(function (colIndex) {
                                let columnName = table.column(colIndex).dataSrc();
                            
                                if (columnName !== "id") {  // do not edit ID column
                                    $(this)
                                        .attr("contenteditable", "true")
                                        .addClass("editable-cell")
                                        .attr("data-field", columnName)
                                        .attr("data-id", data.id);
                                }
                            });
                        },

                        initComplete: function() {
                            const api = this.api();

                            // Populate dropdown filters dynamically (Excel-like)
                            api.columns().every(function() {
                                
                                const column = this;
                                const colIndex = column.index();
                                const filterDropdown = $('#excelFilterRow th').eq(colIndex).find('.filter-dropdown .checkbox-list');

                                // Collect unique values
                                column.data().unique().sort().each(function (d) {
                                    if (d) {
                                        const safeId = `chk_${colIndex}_${d.toString().replace(/\s+/g, '_')}`;
                                        filterDropdown.append(`
                                            <div class="form-check">
                                                <input class="form-check-input column-filter" type="checkbox" value="${d}" id="${safeId}" data-col-index="${colIndex}">
                                                <label class="form-check-label" for="${safeId}">${d}</label>
                                            </div>
                                        `);
                                    }
                                });                                
                            });
                        }
                        
                        
                    });
                    

                    //$("#headerRow").hide()

                    //console.log("After Append :",$('#headerRow').html());

                    

 
                // ðŸ”¹ Column-wise filtering
                $('#dataTable thead .column-filter').on('keyup change', function() {
                    const colIndex = $(this).parent().index();
                    console.log("COL Index Search : ",colIndex);
                    console.log("Search Value :",this.value);
                    table.column(colIndex).search(this.value).draw();
                });


            }
            
            function updateField(rowId, field, value) {
                console.log(`Row Id >> ${rowId}  Fields ${field} Value ${value}`)
                
                $.ajax({       
                        url: "{% url 'update_taskTable_cell' %}",
                        method: "POST",
                        data: {
                            task_tableId:'{{table.id}}',
                            id: rowId,
                            field: field,
                            value: value,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function (response) {
                            console.log("Updated successfully!");
                        },
                        error: function () {
                            alert("Failed to update!");
                        }
                });
            }

            $(document).on("blur", ".editable-cell", function () {
                    let newValue = $(this).text().trim();
                    let field = $(this).data("field");
                    let rowId = $(this).data("id");

                    console.log("Updating:", rowId, field, newValue);

                    updateField(rowId, field, newValue);
            });



        });

        
    </script>

</html>

{% endblock %}